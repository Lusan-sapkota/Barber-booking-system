{% extends "base.html" %}

{% block title %}Sign In - BookaBarber{% endblock %}

{% block content %}
<div class="login-page">
    <!-- Animated Background -->
    <div class="login-bg-animation">
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
            <div class="shape shape-4"></div>
            <div class="shape shape-5"></div>
        </div>
    </div>

    <div class="container-fluid h-100">
        <div class="row h-100 g-0">
            <!-- Welcome Panel -->
            <div class="col-lg-5 login-left-panel">
                <div class="login-welcome-panel">
                    <div class="login-brand">
                        <img src="{{ url_for('static', filename='image/logo/logo.svg') }}" alt="BookaBarber" class="login-logo">
                    </div>
                    
                    <div class="welcome-content">
                        <h2 class="welcome-title">Welcome Back!</h2>
                        <p class="welcome-subtitle">Sign in to manage your appointments and discover amazing barbershops near you.</p>
                        
                        <div class="features-list">
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="feature-text">
                                    <h4>Easy Booking</h4>
                                    <p>Schedule appointments with your favorite barbers</p>
                                </div>
                            </div>
                            
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="feature-text">
                                    <h4>Premium Experience</h4>
                                    <p>Access exclusive deals and premium services</p>
                                </div>
                            </div>
                            
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div class="feature-text">
                                    <h4>Mobile Friendly</h4>
                                    <p>Book on-the-go with our mobile-optimized platform</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Location Display -->
                    <div class="location-display">
                        <div class="location-content">
                            <div class="location-header">
                                <i class="fas fa-map-marker-alt location-icon"></i>
                                <span class="location-label">Your Location</span>
                            </div>
                            <div class="location-text">
                                <span id="user-location">Detecting location...</span>
                                <button id="change-location" class="location-edit-btn" aria-label="Change location">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Login Form Panel -->
            <div class="col-lg-7 login-right-panel">
                <div class="login-form-panel">
                    <div class="login-form-container">
                        <div class="form-header">
                            <h3 class="form-title">Sign In</h3>
                            <p class="form-subtitle">Enter your credentials to access your account</p>
                        </div>
                        
                        <form id="loginForm" method="POST" class="login-form">
                            <!-- User Type Selection -->
                            <div class="user-type-selector">
                                <div class="selector-label">I am a:</div>
                                <div class="user-type-options">
                                    <input type="radio" name="user_type" id="customer" value="customer" checked>
                                    <label for="customer" class="user-type-card">
                                        <div class="type-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <span>Customer</span>
                                    </label>
                                    
                                    <input type="radio" name="user_type" id="barber" value="barber">
                                    <label for="barber" class="user-type-card">
                                        <div class="type-icon">
                                            <i class="fas fa-cut"></i>
                                        </div>
                                        <span>Barber</span>
                                    </label>
                                    
                                    <input type="radio" name="user_type" id="shop_owner" value="shop_owner">
                                    <label for="shop_owner" class="user-type-card">
                                        <div class="type-icon">
                                            <i class="fas fa-store"></i>
                                        </div>
                                        <span>Shop Owner</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Email Field -->
                            <div class="form-group">
                                <div class="input-wrapper">
                                    <i class="fas fa-envelope input-icon"></i>
                                    <input type="email" class="form-control" id="email" name="email" placeholder=" " required>
                                    <label for="email" class="floating-label">Email Address</label>
                                </div>
                            </div>
                            
                            <!-- Password Field -->
                            <div class="form-group">
                                <div class="input-wrapper">
                                    <i class="fas fa-lock input-icon"></i>
                                    <input type="password" class="form-control" id="password" name="password" placeholder=" " required>
                                    <label for="password" class="floating-label">Password</label>
                                    <button type="button" id="togglePassword" class="password-toggle-btn" aria-label="Toggle password visibility">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Form Options -->
                            <div class="form-options">
                                <div class="remember-me">
                                    <input class="form-check-input" type="checkbox" id="remember" name="remember">
                                    <label class="form-check-label" for="remember">Remember me</label>
                                </div>
                                <a href="#" class="forgot-password">Forgot password?</a>
                            </div>
                            
                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary login-btn">
                                <span class="btn-text">Sign In</span>
                                <i class="fas fa-arrow-right btn-icon"></i>
                            </button>
                            
                            <!-- Demo Accounts -->
                            <div class="demo-section">
                                <div class="demo-header">
                                    <span class="demo-title">Quick Demo Access</span>
                                    <small class="demo-subtitle">Try our platform with demo accounts</small>
                                </div>
                                <div class="demo-accounts">
                                    <button type="button" class="demo-account" data-email="customer@demo.com" data-password="password" data-type="customer">
                                        <div class="demo-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="demo-info">
                                            <div class="demo-title-text">Customer Demo</div>
                                            <div class="demo-email">customer@demo.com</div>
                                        </div>
                                    </button>
                                    
                                    <button type="button" class="demo-account" data-email="barber@demo.com" data-password="password" data-type="barber">
                                        <div class="demo-icon">
                                            <i class="fas fa-cut"></i>
                                        </div>
                                        <div class="demo-info">
                                            <div class="demo-title-text">Barber Demo</div>
                                            <div class="demo-email">barber@demo.com</div>
                                        </div>
                                    </button>
                                    
                                    <button type="button" class="demo-account" data-email="owner@demo.com" data-password="password" data-type="shop_owner">
                                        <div class="demo-icon">
                                            <i class="fas fa-store"></i>
                                        </div>
                                        <div class="demo-info">
                                            <div class="demo-title-text">Owner Demo</div>
                                            <div class="demo-email">owner@demo.com</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Sign Up Link -->
                        <div class="signup-prompt">
                            <p>Don't have an account? <a href="{{ url_for('signup') }}" class="signup-link">Create Account</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const locationSpan = document.getElementById('user-location');
    const changeLocationBtn = document.getElementById('change-location');
    const demoAccounts = document.querySelectorAll('.demo-account');
    
    // Handle password visibility toggle
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        const icon = this.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    });
    
    // Handle demo account click
    demoAccounts.forEach(account => {
        account.addEventListener('click', function() {
            const email = this.dataset.email;
            const password = this.dataset.password;
            const userType = this.dataset.type;
            
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
            document.getElementById(userType).checked = true;
            
            // Highlight the selected account
            demoAccounts.forEach(acc => acc.classList.remove('active'));
            this.classList.add('active');
            
            // Add ripple effect
            const ripple = document.createElement('div');
            ripple.className = 'ripple-effect';
            this.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        });
    });
    
    // Detect user location
    detectUserLocation();
    
    // Handle location change
    changeLocationBtn.addEventListener('click', function() {
        const newLocation = prompt('Enter your location:', locationSpan.textContent);
        if (newLocation && newLocation.trim()) {
            locationSpan.textContent = newLocation.trim();
            localStorage.setItem('userLocation', newLocation.trim());
        }
    });
    
    // Handle form submission
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing in...';
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');
        
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Create success notification
                showNotification('success', 'Login successful! Redirecting...');
                
                // Redirect based on user type
                setTimeout(() => {
                    if (result.user_type === 'barber') {
                        window.location.href = '/admin';
                    } else if (result.user_type === 'shop_owner') {
                        window.location.href = '/shop-admin';
                    } else {
                        window.location.href = '/';
                    }
                }, 1500);
            } else {
                showNotification('error', result.message);
            }
        } catch (error) {
            console.error('Login error:', error);
            showNotification('error', 'An error occurred. Please try again.');
        } finally {
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            submitBtn.classList.remove('loading');
        }
    });
    
    function detectUserLocation() {
        // Check if location is stored
        const savedLocation = localStorage.getItem('userLocation');
        if (savedLocation) {
            locationSpan.textContent = savedLocation;
            return;
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    try {
                        const response = await fetch('/api/reverse-geocode', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            const displayLocation = result.city || result.formatted_address.split(',')[0];
                            locationSpan.textContent = displayLocation;
                            localStorage.setItem('userLocation', displayLocation);
                        } else {
                            locationSpan.textContent = 'Location not available';
                        }
                    } catch (error) {
                        console.error('Reverse geocoding error:', error);
                        locationSpan.textContent = 'Location not available';
                    }
                },
                function(error) {
                    locationSpan.textContent = 'Location access denied';
                }
            );
        } else {
            locationSpan.textContent = 'Location not supported';
        }
    }
    
    function showNotification(type, message) {
        const notification = document.createElement('div');
        notification.className = `login-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // Animate out and remove
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
});
</script>
{% endblock %}